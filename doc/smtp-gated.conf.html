<?xml version="1.0"
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>smtp-gated.conf</title>
<meta name="generator" content="http://txt2tags.org" />
</head>
<body bgcolor="white" text="black">
<div align="center">
<h1>smtp-gated.conf</h1>
<h2>Bartlomiej Korupczynski</h2>
<h3>2013-02-26</h3>
</div>


<h1>NAME</h1>

<p>
<b>smtp-gated.conf</b> - The smtp-gated configuration file.
</p>

<h1>VERSION</h1>

<p>
This manual describes smtp-gated v. 1.4.21
</p>

<h1>DESCRIPTION</h1>

<p>
This file defines configuration to be used by daemon.
</p>
<p>
Options are placed one per line, and consists of option name, followed
by number or spaces or tabs, and option value. Empty lines, and lines
starting with # or ; (hash or semicolon) are ignored.
</p>
<p>
Tags in square brackets, show additional information for each variable. See
EXPLANATION later in this manual.
</p>

<h1>MAIN OPTIONS</h1>

<dl>
<dt><b>proxy_name STRING</b></dt><dd>
Name that appears on communicates generated by daemon (usually errors, or
session blocking). Use asterisk '*' to use host name as proxy_name.
</dd>
<dt><b>bind_address IP</b> [RESTART]</dt><dd>
Defines IP the daemon listes on.
</dd>
<dt><b>port PORT</b> [RESTART]</dt><dd>
Defines listening TCP port.
</dd>
<dt><b>outgoing_addr IP</b></dt><dd>
Defines IP for outgoing SMTP connections (this appears as source on MSA servers).
This option has been renamed from source_addr.
</dd>
<dt><b>pidfile FILE</b> [RESTART]</dt><dd>
Defines .pid file path.
</dd>
<dt><b>chroot_path PATH</b> [RESTART]</dt><dd>
If this setting is defined, daemon chroot()'s to this path after forking. This
allows to raise security.
</dd>
<dt><b>set_user USER</b> [RESTART]</dt><dd>
</dd>
<dt><b>set_group GROUP</b> [RESTART]</dt><dd>
Daemon changes it UID/GID to the one defined for username and groupname. This
setting does not allow to specify UID/GID as numbers yet. Do NOT run proxy as
root, as this will break locking.
</dd>
<dt><b>priority INT</b> [RESTART]</dt><dd>
Daemon changes it's priority when it's defined. 0 means "no change". Values as
in setpriority(2).
</dd>
<dt><b>connect_queue INT</b></dt><dd>
Defines listen(2) backlog.
</dd>
<dt><b>enfile_sleep UINT</b></dt><dd>
Sleep time in case ENFILE error occured.
</dd>
<dt><b>on_takeover_cmds UINT</b></dt><dd>
Limit for commands issued by MUA after session takeover.
</dd>
<dt><b>buffer_size UINT</b></dt><dd>
Defines buffer size (in bytes) to track SMTP sessions. Should be above 1500.
</dd>
<dt><b>pipeline_size UINT</b></dt><dd>
Queue size for SMTP PIPELINING extension.
</dd>
<dt><b>pid_hash_size UINT</b></dt><dd>
</dd>
<dt><b>host_hash_size UINT</b></dt><dd>
Controls hashing table size for PID and host counters. Usually there is no much
sense to set it higher than max_connections.
</dd>
</dl>

<h1>RESOURCE CONTROL</h1>

<dl>
<dt><b>limit_core_size INT</b></dt><dd>
Set core dump file size. Helps debugging unexpected problems :) "-1" means to
leave system default setting. "0" turns off core dump completely. If this can
not be changed at runtime, process does not terminate, logging error instead.
</dd>
<dt><b>limit_virt_size INT</b></dt><dd>
</dd>
<dt><b>limit_data_size INT</b></dt><dd>
</dd>
<dt><b>limit_fsize INT</b></dt><dd>
Three above correspond to RLIMIT_AS, RLIMIT_DATA and RLIMIT_FSIZE in
setrlimit(3). You should set this to higher values if you are getting
"Not enought memory" errors (this can also happen upon memory leak).
<p></p>
Keep in mind, that all resource limits are inherited by child process,
including action scripts.
</dd>
</dl>

<h1>MODE</h1>

<p>
Mode defined method, to discover destination IP addres to forward connection to. It differs
obviously on different platforms, but there are couple of common modes, platform independent.
</p>

<dl>
<dt><b>mode fixed|fixed+xclient|remote|remote-udp|getsockname|netfilter|tproxy|tproxy,netfilter|ipfw|ipfilter|pf</b> [ONE,RESTART]</dt><dd>
Set operating mode "remote".
<p></p>
Supported modes are printed as USE_NAT with:
<p></p>
</dd>
</dl>

	<blockquote>
	smtp-gated -V
	</blockquote>
<p>
In all modes except remote/remote-udp proxy must be running on the NAT
machine itself to be able to determine destination IP. If you need to run
proxy on separate machine, it's possible to use policy routing to reroute
all SMTP traffic through proxy machine. This machine should be running in
NAT mode specific to OS (netfilter/ipfw/ipfilter/pf/getsockname/tproxy),
and act as "router" for SMTP traffic only.
</p>
<p>
If you use Linux on your router, then it's possible to run proxy on other
machine (not necessarily Linux), if you run proxy-helper on the router
(see <a href="http://software.klolik.org">http://software.klolik.org</a> for details).
</p>
<p>
Special mode <b>tproxy,netfilter</b> is runtime conditional. It is changed for
every new connection to <b>netfilter</b> for private IPs (10.0.0.0/8, 172.16.0.0/12,
192.168.0.0/16, 169.254.0.0/16), and to <b>tproxy</b> for routable IPs (the rest).
</p>

<h1>FIXED MODE</h1>

<p>
In this mode, all connections are forwarded to one, fixed MSA. This may
be used to filter SMTP traffic just before ISP SMTP server. Use it, if
you want to protect your SMTP server from outside world.
</p>

<dl>
<dt><b>fixed_server IP</b></dt><dd>
IP of MSA to connect to.
</dd>
<dt><b>fixed_server_port PORT</b></dt><dd>
Port to connect to.
</dd>
</dl>

<h1>FIXED+XCLIENT MODE</h1>

<p>
Accepts the same options as FIXED MODE. Uses XCLIENT to impersonate client to MSA.
Allows prefiltering for postfix (v2.3 or later) as (almost) transparent proxy.
</p>

<h1>REMOTE IDENT MODE / REMOTE-UDP IDENT MODE</h1>

<p>
In this mode, daemon is running on dedicated server, serving protection
for couple of routers. For each incoming connection, lookup is performed
on source IP, to discover destination IP. REMOTE requires patched ident
daemon (not public yet), and therefore is useless for most users.
REMOTE-UDP uses so called proxy-helper.
</p>

<dl>
<dt><b>remote_port PORT</b></dt><dd>
Port to lookup ident and destination IP.
</dd>
<dt><b>remote_udp_retries INT</b></dt><dd>
Number of retries for UDP lookup
</dd>
<dt><b>remote_udp_secret INT</b></dt><dd>
Secret used for simple authentication
</dd>
</dl>

<h1>GETSOCKNAME MODE</h1>

<p>
Last resort -- try it if your OS is not supported elsewhere. Should it not run,
you'll receive 'avoiding loop' in your logs.
</p>

<h1>NETFILTER MODE</h1>

<p>
Linux netfilter mode. All connections are forwarded to original MSA. Netfilter
connection tracking is used for destination IP lookup. This mode was formerly
enabled by "use_netfilter" option.
</p>

<h1>TPROXY MODE</h1>

<p>
Linux/netfilter TPROXY module support (since 1.4.16.4) for spoofing source address. This
way proxy preserves source IP of client (useful for public addresses). Please note, that
all port 25 traffic needs to flow through the proxy. It's not a problem if you install
smtp-gated on your "main" Linux router. If you use some external router, you need to
redirect the traffic to proxy interface.
</p>
<p>
You need to have proper kernel header and modules to enable it (linux/netfilter/xt_TPROXY.h
existing probably under /usr/include), and depdends on kernel version. Works for 2.6.32 and
maybe earlier. See ./configure summary.
</p>
<p>
# NAT module must be loaded
iptables -t nat -N placeholder
# packets for proxy need to be tproxied
iptables -t mangle -N divert
iptables -t mangle -A divert -j MARK --set-mark 1
iptables -t mangle -A divert -j ACCEPT
iptables -t mangle -A PREROUTING -p tcp -m socket -j divert
iptables -t mangle -A PREROUTING -p tcp --dport 25 -j TPROXY --tproxy-mark 0x1/0x1 --on-port 9199
# packets for tproxy need to be rerouted
ip rule add fwmark 1 lookup 100
ip route add local 0.0.0.0/0 dev lo table 100
</p>
<p>
Please note that when nf_conntrack_ipv4 module is loaded on 2.6.32 (and maybe on
others), I've seen delay during connection setup, and tcpdump shows double TCP
SYN+ACK, with only the second being accepted, thus introducing delay during connection
setup. Connection continues normally. It's probably some tproxy code fault.
</p>
<p>
Be aware, that if you use external router to redirect only SMTP traffic to proxy
host, you have all the traffic seen twice. Let's say the client IP is 1.1.1.1 connects
to MSA 2.2.2.2, and the proxy is 3.3.3.3:
1. client sends packet from 1.1.1.1 to 2.2.2.2 via router
2. the packet is routed through 3.3.3.3 (having source and destination intact)
3. the proxy accepts connection, does some internal magic and creates *new* connection
with source 1.1.1.1 and destination 2.2.2.2
4. proxy host sends it's own version of packet from 1.1.1.1 to 2.2.2.2 through router
5. router should route the new packet to the MSA 2.2.2.2 according to normal routing
table
6. MSA replies through router to proxy
7. proxy does the reverse magic and replies through router to client
</p>
<p>
So, the packet flow is like:
</p>
	<blockquote>
	client &lt;=1/7=&gt; proxy &lt;=3/6=&gt; MSA
	</blockquote>
<p>
As you can see there are two kind of packets (client&lt;=&gt;proxy and proxy&lt;=&gt;MSA) that
seem to be identical. It's your job, to setup the routers policy routing.
</p>

<h1>IPFW MODE</h1>

<p>
FreeBSD ipfw mode. All connections are forwarded to original MSA. ipfw connection
tracking is used for destination IP lookup.
</p>

<h1>IPFILTER MODE</h1>

<p>
*BSD Packet filter mode. All connections are forwarded to original MSA. ipfilter
connection tracking is used for destionation IP lookup.
</p>

<h1>PF MODE</h1>

<p>
FreeBSD PacketFilter mode. All connections are forwarded to original MSA. pf connection
tracking is used for destination IP lookup. Proxy needs to have proper permissions to
/dev/pf.
</p>

<h1>STATUS</h1>

<dl>
<dt><b>statefile FILE</b></dt><dd>
Defined file which will contains status.
</dd>
<dt><b>statefile_perm OCT</b></dt><dd>
Statefile mode passed to <b>open(2)</b>.
</dd>
<dt><b>statefile_type human|flat|slots</b> [MULTI]</dt><dd>
Defined status format. Flat is preferred for parsing, human is preferred to be
read by humans :) By adding "slots" you can see current slot assignment and
statistics for each session.
</dd>
</dl>

<p>
Status file is written on SIGUSR1: see smtp-gated(8).
</p>

<h1>LOCKING</h1>

<p>
When virus/SPAM is found, user's IP or IP+ident can be blocked for certain
time. After that time, lock is removed, and user is allowed to use SMTP
again. Lockfile has name same as IP, or IP "-" IDENT if ident is used.
</p>
<p>
Administrator can prevent locking some IP (IP+ident), by creating
corresponding lock file with owner other than daemon runs on. This lock file
is not automatically deleted. Contents is ignored, so it can be description,
or sth else.
</p>

<dl>
<dt><b>lock_on virus|spam|maxhost|maxident|dnsbl|regex|earlytalk|ratelimit|never</b> [MULTI]</dt><dd>
Set events locking occurs for. See max_per_host, max_per_ident.
</dd>
<dt><b>lock_duration INT</b> [s]</dt><dd>
Time the lock persists. 0 disables locking, -1 means lock forever (or: until
manually unlocked).
</dd>
<dt><b>lock_path PATH</b></dt><dd>
Directory for lock files.
</dd>
<dt><b>lock_perm OCTAL</b></dt><dd>
Lock files permissions as for open(2). Octal value must be preceded by zero.
</dd>
</dl>

<p>
NOTE: Lock files are checked (and eventually removed) for every incoming
connection. This means that they will exist after expiration, until next
connection from its "owner". In particular, they can be left forever, if
user won't use SMTP any more. You can use crontab to remove stale locks
like this (though it's not necessary for proxy to funcion properly):
</p>
	<blockquote>
	find /var/spool/smtp-gated/lock -type f -user smtpgw -mtime +30 -exec rm {} \;
	</blockquote>

<h1>ACTION SCRIPT</h1>

<p>
Action script is called when virus or spam is found, and if host/ident limit
is reached. If locking is used, action_script is called only when lock is
created (once until unblocked). This makes sure, that script is called only
once for a specified period (until lock expires). Script is obviously called
with proxy UID/GID.
</p>
<p>
Despite of actions taken by script (i.e. firewall-level user lock), you should set
lock_duration high enough (i.e. 15 seconds), to prevent connection-flood translate
to action-flood (scripting is as expensive as fork() and shell expansions).
</p>
<p>
If you have strange problems with action scripts (ENOMEM or ENFILE), that seem to
work well when executed manually, read about resource control above. This will have
impact especially on language interpreters like perl.
</p>

<dl>
<dt><b>action_script FILE</b></dt><dd>
Defines path to script called when virus/spam is found.
</dd>
</dl>

<p>
All parameters for action_script are passed via environment variables:
</p>

<dl>
<dt><b>PROXY_NAME</b></dt><dd>
proxy name as defined in proxy_name in config file [&gt;=1.4.12-rc7]
</dd>
<dt><b>FOUND</b></dt><dd>
contains word "VIRUS" or "SPAM", "MAX_HOST", "MAX_IDENT".
</dd>
<dt><b>VIRUS_NAME</b></dt><dd>
virus name if virus found.
</dd>
<dt><b>SPAM_SCORE</b></dt><dd>
spam score if spam found.
</dd>
<dt><b>SOURCE_IP</b></dt><dd>
source IP.
</dd>
<dt><b>SOURCE_PORT</b></dt><dd>
source port.
</dd>
<dt><b>TARGET_IP</b></dt><dd>
target (SMTP server) IP.
</dd>
<dt><b>TARGET_PORT</b></dt><dd>
target (SMTP server) port.
</dd>
<dt><b>LOCAL_IP</b></dt><dd>
local (proxy) IP as redirected.
</dd>
<dt><b>LOCAL_PORT</b></dt><dd>
local (proxy) port as redirected.
</dd>
<dt><b>IDENT</b></dt><dd>
source ident [REMOTE].
</dd>
<dt><b>IDENT_COUNT</b></dt><dd>
connections count from particular host+ident [REMOTE].
</dd>
<dt><b>HELO</b></dt><dd>
HELO/EHLO string.
</dd>
<dt><b>MAIL_FROM</b></dt><dd>
SMTP "MAIL FROM" line, stripped.
</dd>
<dt><b>RCPTS_TOTAL</b></dt><dd>
total number of mail recipients in session (not transaction).
</dd>
<dt><b>SIZE</b></dt><dd>
message size [bytes].
</dd>
<dt><b>TRANSACTION</b></dt><dd>
transaction number, starting from 1.
</dd>
<dt><b>AUTH</b></dt><dd>
authentication flags bitmap: 1=supported, 2=accepted, 4=rejected;
see AUTH_FLAG_* in src/smtp-gated.h
</dd>
<dt><b>SPOOL_NAME</b></dt><dd>
spool file name.
</dd>
<dt><b>LOCK_FILE</b></dt><dd>
lock file name.
</dd>
<dt><b>TIME</b></dt><dd>
time of connection start, human readable text.
</dd>
<dt><b>UNIXTIME</b></dt><dd>
time of connection start, unix timestamp.
</dd>
</dl>

<h1>SPOOLING</h1>

<dl>
<dt><b>spool_path PATH</b></dt><dd>
Directory for temporary message files.
</dd>
<dt><b>spool_perm OCTAL</b></dt><dd>
Temporary files permissions as for open(2). Octal
value must be preceded by zero.
</dd>
<dt><b>spool_leave_on error|spam|virus|never|always</b> [MULTI]</dt><dd>
Set events, spool file is left for. If set to "never", spool is always deleted.
If you choose "always" please note that for multi-transactional session, only the last mail is saved. Spools are also removed if they exceed size limit or if there's error during file write (including but not limited to drive full).
</dd>
</dl>

<h1>TIMEOUTS</h1>

<p>
All timeouts are specified in seconds.
</p>

<dl>
<dt><b>timeout_direct UINT</b></dt><dd>
Timeout for direct proxy session. This type of session is used on TLS connections.
</dd>
<dt><b>timeout_lookup UINT</b> [REMOTE]</dt><dd>
Timeout for lookup.
</dd>
<dt><b>timeout_scanner UINT</b></dt><dd>
Timeout for antivirus scanner engine.
</dd>
<dt><b>timeout_spam UINT</b></dt><dd>
Timeout for antispam scanner engine.
</dd>
<dt><b>timeout_session UINT</b></dt><dd>
Timeout for fake session (when virus/SPAM is blocked).
</dd>
<dt><b>timeout_idle UINT</b></dt><dd>
Timeout for idle sessions. Prevents stale connections.
</dd>
<dt><b>timeout_connect UINT</b></dt><dd>
Timeout for connecting to remote MSA.
</dd>
</dl>

<h1>AUTHENTICATION CONTROL</h1>

<p>
Proxy can limit access to MSA, according to SMTP AUTH support and state.
For now, there is no way to whitelist host or MSA.
</p>

<dl>
<dt><b>auth_require no|ifsupported|mandatory</b> [ONE]</dt><dd>
Set authorization requirements:
</dd>
</dl>

	<blockquote>
	<b>no</b>			do not require any authorization, pass all messages.
	</blockquote>
	<blockquote>
	<b>ifsupported</b>		require authorization if MSA advertises support for it. If authorization is not advertised, mail is passed. If authorization is advertised, mail is passed only if client has authorized successfully.
	</blockquote>
	<blockquote>
	<b>mandatory</b>		require authorization for all connections. It MSA does not support authorization, no mail is passed.
	</blockquote>
<p>
  Authentication state is logged in "CLOSE by=... auth=N", where N is bitwise OR for following values:
</p>
	<blockquote>
	<b>1</b>			MSA supports auth (advertised in EHLO response)
	</blockquote>
	<blockquote>
	<b>2</b>			user authenticated successfuly
	</blockquote>
	<blockquote>
	<b>4</b>			user authentication failed (rejected by MSA)
	</blockquote>

<dl>
<dt><b>auth_skip none|direct|antivir|antispam|dnsbl|regex</b> [MULTI]</dt><dd>
Skip checking/scanning if session is authenticated. <b>direct</b> is special one: after authentication, session
goes to <b>DIRECT PROXY</b> mode. Using any other option together with <b>direct</b> obviously makes no sense.
Note that 'auth_skip dnsbl' delays dnsbl rejection to MAIL FROM stage (as opposite to connect stage).
</dd>
</dl>

<h1>LIMITS</h1>

<p>
All sizes are specified in bytes.  Loadavg limits can be disabled by specyfing zero, but this is not recommended.
</p>

<dl>
<dt><b>max_connections UINT</b> [RESTART]</dt><dd>
Total maximum connections.
</dd>
<dt><b>max_per_host UINT</b></dt><dd>
Maximum connections per source IP (see also: lock_on maxhost).
</dd>
<dt><b>max_per_ident UINT</b> [REMOTE]</dt><dd>
maximum connections per IP+ident (see also: lock_on maxident).
</dd>
<dt><b>max_load FLOAT</b></dt><dd>
Reject connections if load is above this setting.
</dd>
<dt><b>size_limit UINT</b></dt><dd>
Limit maximum message size. 0=disabled (default).
</dd>
<dt><b>scan_max_size UINT</b></dt><dd>
av-scan messages with size up to this limit.
</dd>
<dt><b>spam_max_size INT</b></dt><dd>
SPAM-scan messages with size up to this limit. Should spam scanning be turned off, set it to 0 (default).
</dd>
<dt><b>spam_max_load FLOAT</b></dt><dd>
Don't SPAM-scan messages if load above this setting.
</dd>
<dt><b>spam_threshold FLOAT</b></dt><dd>
Treat message as SPAM if it's score is equal/greater than this value.
</dd>
</dl>

<h1>MISCELLANOUS</h1>

<dl>
<dt><b>ignore_errors BOOL</b></dt><dd>
Continue when possible even if error occured (i.e. virus scanner failure).
</dd>
</dl>

<h1>LOGGING</h1>

<p>
Daemon logs messages via syslog, facility daemon.
</p>

<dl>
<dt><b>log_helo BOOL</b></dt><dd>
Logs HELO/EHLO issued by client.
</dd>
<dt><b>log_mail_from accepted|rejected|base64|off</b> [MULTI]</dt><dd>
Client MAIL FROM logging options:
</dd>
</dl>

	<blockquote>
		<blockquote>
		off		<a href="log">do not</a>
		accepted	log if address is accepted by MSA
		rejected	log if address is rejected by MSA
		base64		log as base64 encoded md5 hash of e-mail
		</blockquote>
	</blockquote>

<dl>
<dt><b>log_rcpt_to</b> [MULTI]</dt><dd>
Client RCPT TO logging mask. (see log_mail_from).
</dd>
<dt><b>email_length UINT</b></dt><dd>
MAIL FROM/RCPT TO email length limit (before optional md5 encoding).
</dd>
<dt><b>log_level debug|info|notice|warning|err|alert|emerg|crit</b> [ONE,RESTART]</dt><dd>
Defined log level, as used by syslog(3):
</dd>
</dl>

	<blockquote>
	crit	Emergency messages (highest priority)
	emerg	Critical, requires intervention
	alert	Critical messages
	err	Errors
	warning	Warnings
	notice	Normal, but significiant messages
	info	Informational messages
	debug	Debugging messages (lowest priority)
	</blockquote>

<dl>
<dt><b>log_facility user|mail|daemon|auth|news|authpriv|local0|local1|local2|local3|local4|local5|local6|local7</b> [ONE,RESTART]</dt><dd>
Defined log facility, as used by syslog(3).
</dd>
</dl>

<h1>MANGLING</h1>

<dl>
<dt><b>nat_header</b></dt><dd>
Header injected into message stream header (sent to MSA); default is "X-NAT-Received" [&gt;=1.4.12-rc5]
</dd>
<dt><b>nat_header_type none|simple|ip-only</b> <a href="nat_header">ONE, OLD:</a></dt><dd>
Turns on/off injecting X-NAT-Received headers to messages. [&gt;=1.4.12-rc5]
</dd>
</dl>

	<blockquote>
	none	<a href="header">no</a>
	ip-only		include only source IP in header
	generic		generic header (MSA-like)
	</blockquote>

<dl>
<dt><b>spool_header</b></dt><dd>
Header injected into message spool header (not sent to MSA, visible in AV-scanner and
AS-scanner), default is "X-Proxy-Spool-Info" [&gt;=1.4.12-rc5]
</dd>
<dt><b>abuse STRING</b></dt><dd>
Sets "abuse" info in full X-NAT-Received header.
</dd>
</dl>

<h1>SCANNERS</h1>

<dl>
<dt><b>scanner_path FILE</b></dt><dd>
not used.
</dd>
<dt><b>antivirus_type off|clamd|mksd</b> [ONE]</dt><dd>
Choose antivirus to use. "off" means no scanning.
</dd>
<dt><b>antivirus_path SOCKET</b></dt><dd>
Path for clamd socket.
</dd>
<dt><b>antispam_type off|spamassassin</b> [ONE]</dt><dd>
Choose antispam to use. "off" means no scanning.
</dd>
<dt><b>antispam_path SOCKET</b></dt><dd>
Path for spamd socket.
</dd>
<dt><b>dspam_storage PATH</b></dt><dd>
DSPAM storage home.
</dd>
</dl>

<h1>DNSBL</h1>

<dl>
<dt><b>dnsbl zone,zone,[...]</b></dt><dd>
Check incoming connections on specified DNSBL lists. Probably makes sense for FIXED MODE only.
See also: lock_on dnsbl
</dd>
</dl>

<h1>SPF</h1>

<p>
Check messages against SPF. IP used for SPF verification depends on <b>spf</b> option.
</p>

<dl>
<dt><b>spf none|incoming|outgoing|fixed</b> [ONE]</dt><dd>
Enables SPF checking.
</dd>
</dl>

	<blockquote>
	<b>none</b>	SPF turned off
	</blockquote>
	<blockquote>
	<b>incoming</b>	check against client incoming-IP, probably useful for <b>mode fixed</b> only.
	</blockquote>
	<blockquote>
	<b>outgoing</b>	check against proxy outgoing-IP (outgoing_addr), probably useful for NAT-mode only.
	</blockquote>
	<blockquote>
	<b>fixed</b>	check against static IP defined by <b>spf_fixed_ip</b>
	</blockquote>

<dl>
<dt><b>spf_log_only yes|no</b></dt><dd>
Logging only of SPF results, no mail rejection.
<p></p>
</dd>
<dt><b>spf_fixed_ip IP</b></dt><dd>
Static IP used by <b>spf fixed</b> only. Useful if proxy is behind NAT.
</dd>
</dl>

<h1>REGEX</h1>

<dl>
<dt><b>regex_enforce_helo REGEX</b></dt><dd>
</dd>
<dt><b>regex_enforce_mail_from REGEX</b></dt><dd>
</dd>
<dt><b>regex_enforce_rcpt_to REGEX</b></dt><dd>
<p></p>
Rejects HELO/MAIL FROM/RCPT TO if don't match regex_enforce_*.
<p></p>
</dd>
<dt><b>regex_reject_helo REGEX</b></dt><dd>
</dd>
<dt><b>regex_reject_mail_from REGEX</b></dt><dd>
</dd>
<dt><b>regex_reject_rcpt_to REGEX</b></dt><dd>
<p></p>
Rejects HELO/MAIL FROM/RCPT TO if they match regex_reject_*.
</dd>
</dl>

<p>
Please note, regex matching occurs only when corresponding command is given. As a result,
it is not possible to check if there was no HELO/EHLO.
See also: <b>auth_skip regex</b>, <b>lock_on regex</b>.
</p>

<h1>EARLYTALK</h1>

<p>
Earlytalker means MUA which starts to send SMTP commands before the greeting from MSA.
This is SMTP protocol violation and no legitimate mail software should do that.
</p>

<dl>
<dt><b>earlytalker BOOLEAN</b></dt><dd>
Enable/disable earlytalker rejection.
</dd>
<dt><b>lock_on earlytalker</b></dt><dd>
Enable locking earlytalkers.
</dd>
</dl>

<h1>RATE LIMIT</h1>

<p>
Limits for client per time-period.
</p>

<dl>
<dt><b>ratelimit_path PATH</b></dt><dd>
Path for ratelimit files ("database"). If rate limiting is enabled, these get
rewritten for every connection, so it's probably a bad idea to put them on any
kind of Flash (SSD) drive.
<p></p>
</dd>
<dt><b>ratelimit_period SECONDS</b></dt><dd>
Time period for limits. 0 disables rate limiting entirely.
<p></p>
</dd>
<dt><b>ratelimit_generation UINT</b></dt><dd>
Generation is saved in ratelimiting structures together with ratelimit_* limits.
Limits are updated only if this generation is increased. Recomended format is
YYYYMMDDHHMMSS. To setup personalised limit, write them with really high generation
(no tool for this yet).
<p></p>
</dd>
<dt><b>ratelimit_connections INT</b></dt><dd>
</dd>
<dt><b>ratelimit_sessions INT</b></dt><dd>
</dd>
<dt><b>ratelimit_recipients INT</b></dt><dd>
</dd>
<dt><b>ratelimit_bytes INT</b></dt><dd>
Limit per duration limits for each client (host or host+ident). Limit database
is saved into ratelimit_path directory. Setting any limit to 0 disables that
limit, and setting duration to 0 disables all limits.
</dd>
<dt><b>ratelimit_mailfrom_rejects UINT</b></dt><dd>
</dd>
<dt><b>ratelimit_rcptto_rejects UINT</b></dt><dd>
</dd>
<dt><b>ratelimit_auth_rejects UINT</b></dt><dd>
Limits on MAIL FROM, RCPT TO and AUTH rejected by MSA.
<p></p>
See also: <b>lock_on ratelimit</b>.
</dd>
</dl>

<h1>EARLYTALK</h1>

<p>
If client sends any command before MSA greeting, gets kicked. Current
implementation does not delay the greeting by itself, but relies on the MSA.
</p>

<dl>
<dt><b>earlytalk BOOL</b></dt><dd>
enable/disable earlytalk check (enabled by default)
See also: lock_on earlytalk
</dd>
</dl>

<h1>COMMAND FILTER</h1>

<dl>
<dt><b>forbid_starttls BOOL</b></dt><dd>
Forbid entering TLS mode.
</dd>
</dl>

<h1>MESSAGES</h1>

<p>
All messages sent to user are customisable.
</p>

<dl>
<dt><b>locale NAME</b></dt><dd>
Changes locale of system errors from strerror(3). See setlocale(3). Does not change messages
generated by daemon itself.
</dd>
</dl>

<h1>MESSAGES MAIN</h1>

<dl>
<dt><b>msg_virus_found</b></dt><dd>
Virus found in message.
</dd>
<dt><b>msg_virus_locked</b></dt><dd>
User locked, virus or SPAM found before.
</dd>
<dt><b>msg_spam_found</b></dt><dd>
SPAM found in message.
</dd>
<dt><b>msg_unknown_virus</b></dt><dd>
Virus name substituted, when it's unknown.
</dd>
<dt><b>msg_spool_problem</b></dt><dd>
Spooling file name problem.
</dd>
<dt><b>msg_spool_open_fail</b></dt><dd>
Spool creation failed.
</dd>
<dt><b>msg_pipeline_full</b></dt><dd>
Pipeline queue full.
</dd>
<dt><b>msg_scanner_failed</b></dt><dd>
Scanner has failed.
</dd>
<dt><b>msg_cannot_connect</b></dt><dd>
Cannot connect to MSA.
</dd>
<dt><b>msg_connect_timeout</b></dt><dd>
Connection to MSA timed out.
</dd>
<dt><b>msg_nomem</b></dt><dd>
Out of memory
</dd>
</dl>

<h1>MESSAGES FAKE MSA SESSION</h1>

<dl>
<dt><b>msg_hello</b></dt><dd>
Hello message.
</dd>
<dt><b>msg_sign_off</b></dt><dd>
Signing off.
</dd>
<dt><b>msg_virus_no_more</b></dt><dd>
Virus found, please end the session.
</dd>
<dt><b>msg_session_timeout</b></dt><dd>
Session timed out.
</dd>
<dt><b>msg_proto_error</b></dt><dd>
Protocol error.
</dd>
<dt><b>msg_transaction_failed</b></dt><dd>
Fake MSA transaction failed.
</dd>
<dt><b>msg_unimpl_command</b></dt><dd>
Unimplemented command (SMTP verb).
</dd>
<dt><b>msg_temp_unavail</b></dt><dd>
Service temporarily unavailable.
</dd>
</dl>

<h1>MESSAGES LIMITS</h1>

<dl>
<dt><b>msg_max_reached</b></dt><dd>
Total connections limit reached, try again later.
</dd>
<dt><b>msg_max_per_host</b></dt><dd>
Connections limit for IP reached, try again later.
</dd>
<dt><b>msg_max_per_ident</b></dt><dd>
Connections limit for IP+ident reached, try again later.
</dd>
<dt><b>msg_system_load</b></dt><dd>
System load too high, try again later.
</dd>
</dl>

<h1>MESSAGES FOR REMOTE IDENT MODE</h1>

<dl>
<dt><b>msg_malformed_ip</b> [REMOTE]</dt><dd>
Malformed IP received
</dd>
<dt><b>msg_lookup_failed</b></dt><dd>
Lookup failed.
</dd>
<dt><b>msg_lookup_timeout</b></dt><dd>
Lookup timed out.
</dd>
<dt><b>msg_lookup_mismatch</b></dt><dd>
Invalid lookup response format.
</dd>
<dt><b>msg_lookup_nomem</b></dt><dd>
Lookup failed, not enough memory.
</dd>
</dl>

<h1>DIRECT PROXY</h1>

<p>
Direct proxy is a mode where proxy simply passes traffic between client and MSA without any interaction or processing.
This of course means, that any checks/limits/quota/etc are ignored. You cannot force this mode by config (it would be
pointless to have the proxy), however proxy enters this mode if:
</p>

<dl>
<dt>1.</dt><dd>
STARTTLS is successfully requested by the client (proxy couldn't process encrypted traffic anyway)
</dd>
<dt>2.</dt><dd>
<b>auth_skip direct</b> is set and client has successfully authenticated to the MSA.
</dd>
</dl>

<p>
As the traffic in direct proxy mode is not processed, this means less overhead to the proxy host.
</p>

<h1>FAQ</h1>

<p>
These are popular Questions and Answers:
</p>

<dl>
<dt><b>Q1: Antispam is not working! What is wrong?</b></dt><dd>
You must change max_spam_size to something above 0 to turn on antispam scanning. It's set to 0 by default, and this means turning antispam off. Also, set antispam_type.
<p></p>
</dd>
<dt><b>Q2: Spammers don't get locked! What is wrong?</b></dt><dd>
If you want to block spammers, set "lock_on spam[,...]", and see Question#1.
<p></p>
</dd>
<dt><b>Q3: I wanted to block some user by creating lockfile manually, but now his traffic is not even scanned!</b></dt><dd>
Creating lockfile with owner other than proxy process runs with, will protect that host from being locked. The contents of file does not matter.
<p></p>
</dd>
<dt><b>Q4: My header is invalid after upgrading!</b></dt><dd>
nat_header changed into nat_header_type since 1.4.12-rc5, so after upgrade header will not be injected unless you rename it in configuration file.
<p></p>
</dd>
<dt><b>Q5: I don't have idents in my logs or headers, why?</b></dt><dd>
It simple -- ident is used in REMOTE IDENT mode, which is currently not available.
<p></p>
</dd>
<dt><b>Q6: I don't see X-NAT-Received header in mails, why?</b></dt><dd>
Please remember, that mail sent with TLS is not scanned. Also, check nat_header_type directive in your config file, and nat_header (see MANGLING above).
<p></p>
</dd>
<dt><b>Q7: When X-Virus-Scan and/or X-Spam-Status headers will be supported?</b></dt><dd>
The answer is: never. Reason is simple -- proxy is passing-thru email headers and body. Because headers are sent first, we can't predict spam-score or virus presence. The main assumption for this project was not to buffer mail before forwarding, so this option won't appear.
<p></p>
</dd>
<dt><b>Q8: I have many locks left, even if they should be gone long time ago!</b></dt><dd>
Please see note for the LOCKING.
<p></p>
</dd>
<dt><b>Q9: Host gets locked, lock file appears, but he can still send e-mails!</b></dt><dd>
Please *do not* run proxy as root, and set set_user properly. If you do, remove all locks manually.
<p></p>
</dd>
<dt><b>Q10: action_script does not work!</b></dt><dd>
Please read about ACTION SCRIPT. Script will not be called once the lock exists. If you were testing "by hand" by writing some text to some log file, make sure the script has permissions to write to it too, i.e. by temporarily doing chmod a+rw on that log file. You should also check if disabling limit_* variables will do the trick, and if the answer is yes, try to set them high enough for script needs.
<p></p>
</dd>
<dt><b>Q11: spamassassin gets timeout</b></dt><dd>
Please check if "spamd -L" resolves this issue.
<p></p>
</dd>
<dt><b>Q12: clamd fails with: SCAN:FAILED [...] result=lstat() failed.</b></dt><dd>
Antispam and antivirus scanners need to have access to spool files (spool_path, spool_perm).
If you want to seal your setup, you can add clamav user smtpgw group, and deny other to access the spool directory.
<p></p>
</dd>
<dt><b>Q13: action script does not seem to work well when executed by smtp-gated, possibly failing with ENFILE or ENOMEM</b></dt><dd>
Read notes about resource control and action scripts.
</dd>
</dl>

<h1>CHANGES</h1>

<p>
  1.4.16-rc2:
  		spf:
</p>
	<blockquote>
		<blockquote>
			<blockquote>
			changed: source -&gt; incoming
			</blockquote>
		</blockquote>
	</blockquote>
	<blockquote>
		<blockquote>
			<blockquote>
			added: fixed
			</blockquote>
		</blockquote>
	</blockquote>
<p>
  1.4.16-rc1:
</p>
	<blockquote>
		<blockquote>
		added options:
		</blockquote>
	</blockquote>
	<blockquote>
		<blockquote>
			<blockquote>
			dnsbl
			</blockquote>
		</blockquote>
	</blockquote>
	<blockquote>
		<blockquote>
			<blockquote>
			spf
			</blockquote>
		</blockquote>
	</blockquote>
	<blockquote>
		<blockquote>
			<blockquote>
			spf_log_only
			</blockquote>
		</blockquote>
	</blockquote>
	<blockquote>
		<blockquote>
			<blockquote>
			regex_*
			</blockquote>
		</blockquote>
	</blockquote>
	<blockquote>
		<blockquote>
		renamed options:
		</blockquote>
	</blockquote>
	<blockquote>
		<blockquote>
			<blockquote>
			source_addr -&gt; outgoing_addr
			</blockquote>
		</blockquote>
	</blockquote>
	<blockquote>
		<blockquote>
		changed options:
		</blockquote>
	</blockquote>
	<blockquote>
		<blockquote>
			<blockquote>
			nat_header_type
			</blockquote>
		</blockquote>
	</blockquote>
	<blockquote>
		<blockquote>
			<blockquote>
			auth_require
			</blockquote>
		</blockquote>
	</blockquote>
	<blockquote>
		<blockquote>
			<blockquote>
			auth_skip: "regex", "dnsbl" added
			</blockquote>
		</blockquote>
	</blockquote>
	<blockquote>
		<blockquote>
			<blockquote>
			lock_on: "regex", "dnsbl" added
			</blockquote>
		</blockquote>
	</blockquote>
<p>
  1.4.14-rc2:	renamed options:
</p>
	<blockquote>
		<blockquote>
		dumpfile -&gt; statefile
		</blockquote>
	</blockquote>
	<blockquote>
		<blockquote>
		dumpfile_perm -&gt; statefile_perm
		</blockquote>
	</blockquote>
<p>
  1.4.14-rc1:	Changed many configuration options. Please review your previous configuration using:
</p>
	<blockquote>
	smtp-gated -t /path/to/smtp-gated.conf
	</blockquote>

<h1>REPORTING BUGS</h1>

<p>
If you are willing to sent me a bug report, please check manuals first to
ensure you have configured properly. In report, please include:
</p>

<ol>
<li>output of "smtp-gated -V"
</li>
<li>config file (as attachment if big)
</li>
<li>full logs related to e-mails sent, with "log_level debug"
</li>
<li>optional mail header (as sent from proxy).
<p></p>
If you get 'unknown option' or 'invalid value' errors, you can list all
supported options with supported values by running:
</li>
</ol>

	<blockquote>
	smtp-gated -T
	</blockquote>

<h1>EXPLANATION</h1>

<dl>
<dt><b>INT</b></dt><dd>
Signed integer
</dd>
<dt><b>UINT</b></dt><dd>
Unsigned number; can be specified as decimal, octal (beginning with 0), or hexadecimal (beginning with 0x or 0X)
</dd>
<dt><b>BOOL</b></dt><dd>
Boolean (0, 1)
</dd>
<dt><b>FLOAT</b></dt><dd>
Floating-point number
</dd>
<dt><b>IP</b></dt><dd>
Valid IP address
</dd>
<dt><b>PORT</b></dt><dd>
Valid IP port
</dd>
<dt><b>STRING</b></dt><dd>
Arbitrary text string
</dd>
<dt><b>PATH</b></dt><dd>
Valid directory name
</dd>
<dt><b>FILE</b></dt><dd>
Valid file name
</dd>
<dt><b>SOCKET</b></dt><dd>
UNIX socket or TCP socket. UNIX socket must begin with backslash ("/"), otherwise path is considered TCP socket and must be submitted in following form: ip:port (i.e. 127.0.0.1:1097)
</dd>
<dt><b>[ONE]</b></dt><dd>
Only one value allowed.
</dd>
<dt><b>[MULTI]</b></dt><dd>
Multiple values allowed, comma separated (do NOT insert any white space before comma).
</dd>
<dt><b>[RESTART]</b></dt><dd>
This option needs full restart to take effect.
</dd>
<dt><b>[REMOTE]</b></dt><dd>
This option affects REMOTE IDENT MODE only.
</dd>
</dl>

<h1>GLOSSARY</h1>

<dl>
<dt>MSA</dt><dd>
Mail Submission Agent
</dd>
</dl>

<h1>SEE ALSO</h1>

<p>
smtp-gated(8)
</p>

<h1>HOMEPAGE</h1>

<p>
<a href="https://vpithart.github.io/smtp-gated/">https://vpithart.github.io/smtp-gated/</a>
</p>

<h1>AUTHOR</h1>

<p>
Bartlomiej Korupczynski
</p>
<p>
<img align="middle" src="who.png" border="0" alt=""/>
</p>

<!-- xhtml code generated by txt2tags 2.6 (http://txt2tags.org) -->
<!-- cmdline: txt2tags -t xhtml -i smtp-gated.conf.t2t -o smtp-gated.conf.html -->
</body></html>
